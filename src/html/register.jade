| <%@ page contentType="text/html;charset=UTF-8" language="java" %>
| <%@ page import="javax.naming.*" %>
| <%@ page import="javax.sql.DataSource" %>
| <%@ page import="java.sql.*" %>
| <%@ page import="java.util.*" %>
| <%@ page import="java.nio.charset.StandardCharsets" %>
| <%@ page import="java.security.MessageDigest" %>
| <%!
| 	public String bytesToHex(byte[] bytes) {
| 		StringBuffer result = new StringBuffer();
| 		for (byte byt : bytes) result.append(Integer.toString((byt & 0xff) + 0x100, 16).substring(1));
| 		return result.toString();
| 	}
| %>
| <%
| 	Context initialContext = new InitialContext();
| 	Context environmentContext = (Context)initialContext.lookup("java:/comp/env");
| 	DataSource dataSource = (DataSource)environmentContext.lookup("jdbc/iae_test");
| 	Connection conn = dataSource.getConnection();
| 	
| 	Boolean invalidForm = false;
| 	Boolean passwordNotEqual = false;
| 	
| 	String firstName = request.getParameter("firstName");
| 	String secondName = request.getParameter("secondName");
| 	String email = request.getParameter("email");
| 	String password = request.getParameter("password");
| 	String confirmPassword = request.getParameter("confirmPassword");
| 	if (firstName != null && !firstName.isEmpty() &&
| 		secondName != null && !secondName.isEmpty() &&
| 		email != null && !email.isEmpty() &&
| 		password != null && !password.isEmpty() &&
| 		confirmPassword != null && !confirmPassword.isEmpty()) {
| 		
| 		if (password.equals(confirmPassword)) {
| 			String hashedPassword = new String(Base64.getEncoder().encode(MessageDigest.getInstance("SHA-256").digest(password.getBytes(StandardCharsets.UTF_8))));
| 			
| 			PreparedStatement statement = conn.prepareStatement("INSERT INTO `accounts` VALUES (?, ?, ?, ?, ?, default, default)");
| 			
| 			statement.setString(1, bytesToHex(MessageDigest.getInstance("SHA-256").digest(String.format("%s%s%s%s%d", firstName, secondName, email, hashedPassword, System.currentTimeMillis() / 1000L).getBytes(StandardCharsets.UTF_8))).substring(0, 32));
| 			statement.setString(2, firstName);
| 			statement.setString(3, secondName);
| 			statement.setString(4, email);
| 			statement.setString(5, hashedPassword);
| 			
| 			statement.execute();
| 
| 			PreparedStatement userStatement = conn.prepareStatement("SELECT id, password FROM `accounts` WHERE email = ?");
| 			userStatement.setString(1, email);
| 			
| 			ResultSet users = userStatement.executeQuery();
| 			
| 			if (users.next()) {
| 				PreparedStatement sessionStatement = conn.prepareStatement("DELETE FROM `sessions` where `userId`= ?");
| 				sessionStatement.setString(1, users.getString("id"));
| 				sessionStatement.execute();
| 			
| 				sessionStatement = conn.prepareStatement("INSERT INTO `sessions` VALUES (?, ?, default, default)");
| 				sessionStatement.setString(1, bytesToHex(MessageDigest.getInstance("SHA-256").digest(String.format("%s%s%s%d", users.getString("id"), email, hashedPassword, System.currentTimeMillis() / 1000L).getBytes(StandardCharsets.UTF_8))).substring(0, 32));
| 				sessionStatement.setString(2, users.getString("id"));
| 				sessionStatement.execute();
| 			}
| 			
| 			conn.close();
| 			response.sendRedirect("user-cp.html");
| 		} else {
| 			passwordNotEqual = true;
| 		}
| 	} else {
| 		invalidForm = true;
| 	}
| %>
| 

doctype html
html
	head
		meta(charset="utf-8")
		meta(name="viewport", content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no")
		
		title Registrieren – FESTIVAL Aviation
		
		link(rel="stylesheet",href="css/aviation.css")
		link(rel="stylesheet",href="css/login.built.css")
	body
		.content-wrapper
			section.logo-container
				.section-content.row.centered
					.column.column-12.medium-4
						img(src="img/logo-dark.svg")
						
			section.login
				.section-content.row.centered
					.column.column-12.medium-4
						.login-container
							form.signin-form(method="POST",action="register.jsp",novalidate)
								.form-textbox-wrapper
									input.form-textbox(type="text",name="firstName",id="firstName",placeholder=" ")
									span.form-textbox-placeholder Vorname
								.form-textbox-wrapper
									input.form-textbox(type="text",name="secondName",id="secondName",placeholder=" ")
									span.form-textbox-placeholder Nachname
								.form-textbox-wrapper
									input.form-textbox(type="email",name="email",id="email",placeholder=" ")
									span.form-textbox-placeholder E-Mail-Adresse
								.form-textbox-wrapper
									input.form-textbox(type="password",name="password",id="password",placeholder=" ")
									span.form-textbox-placeholder Passwort
								.form-textbox-wrapper
									input.form-textbox(type="password",name="confirmPassword",id="confirmPassword",placeholder=" ")
									span.form-textbox-placeholder Passwort bestätigen
								button.call Registrieren
							a(href="login.jsp") Schon registriert?